# Copyright (c) 2021 Huawei Device Co., Ltd.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---

# This is a non-public extension of Panda instruction set architecture.
# Each group from the section below defines a single 'builtin.*' instruction
# without predefined semantics. Each 'builtin.*' instruction can be
# dispatched to maximum 256 handlers, each executing in the interpreter's
# context (like all public instruction handlers do). These extension handlers
# are called builtins. Dispatching 'builtin.*' instructions to actual handlers
# is achieved via first immediate operand of each 'builtin.*' instruction.
#
# Following restrictions apply to the 'groups' section:
#
# * The entire 'groups' section must have exactly the same format as isa.yaml.
# * Each group must define exactly one 'builtin.*' instruction.
# * Each 'builtin.*' instruction must have exactly one encoding format.
#   This limitation is introduced to avoid writing complex and untestable
#   code generation routines -- currently "one instruction <=> one format"
#   is enough. Feel free to remove this constraint on demand.
# * There must be no 'builtin.*' instructions with the same signature
#   (consult with the API for signature validation rules).
#
# Following restrtictions apply to the 'builtins' section:
#
# * All builtin names must be unique
# * Signature of each builtin must match exactly one signature of some
#   'builtin.*' instruction (consult with the API for signature matching rules).
#   Please note that there is no need to specify correspondence between
#   builtins and 'builtin.*' instructions explicitly, this done by the API.
#
# Following runtime restrictions apply to builtins handlers:
#
# * Builtin handler is not expected to run in parallel with GC at STW phase
# * Builtin handler must not trigger runtime operations that start GC
#
# NB! Important note about ordering and dispatch table layout.
# The order of builtin definitions in this file is not important. However,
# API may reorder these definitions to guarantee following layout
# for the dispatch table:
#
# public_opcode_01
# public_opcode_02
# ...
# builtin_opcode_01
# builtin_opcode_02
# ...
# builtin_01_for_builtin_opcode_01 \
# builtin_02_for_builtin_opcode_01 | All builtins with signature of builtin_opcode_01
# builtin_03_for_builtin_opcode_01 /
# builtin_01_for_builtin_opcode_02 \
# ...                              | All builtins with signature of builtin_opcode_02
# builtin_NN_for_builtin_opcode_02 /
#

groups:
  - title: Built-in operations without explicit operands
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm)
      acc = builtin(acc)
    semantics: |
      skip
    instructions:
      - sig: builtin.acc imm
        acc: inout:top
        format: [op_imm_8]

  - title: Built-in two address binary operations on accumulator
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm)
      acc = builtin(acc, v)
    semantics: |
      skip
    instructions:
      - sig: builtin.bin2 imm, v:in:top
        acc: inout:top
        format: [op_imm_8_v_8]

  - title: Built-in three address operations on accumulator
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm)
      acc = builtin(acc, v1, v2)
    semantics: |
      skip
    instructions:
      - sig: builtin.tern3 imm, v1:in:top, v2:in:top
        acc: inout:top
        format: [op_imm_8_v1_8_v2_8]

  - title: Built-in four address operations on accumulator
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm)
      acc = builtin(acc, v1, v2, v3)
    semantics: |
      skip
    instructions:
      - sig: builtin.quatern4 imm, v1:in:top, v2:in:top, v3:in:top
        acc: inout:top
        format: [op_imm_8_v1_8_v2_8_v3_8]

  - title: Built-in five address operations on accumulator
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm)
      acc = builtin(acc, v1, v2, v3, v4)
    semantics: |
      skip
    instructions:
      - sig: builtin.quin5 imm, v1:in:top, v2:in:top, v3:in:top, v4:in:top
        acc: inout:top
        format: [op_imm_8_v1_8_v2_8_v3_8_v4_8]

  - title: Built-in opcode for imm8_v
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm1)
      acc = builtin(imm2, acc, v)
    semantics: |
      skip
    instructions:
      - sig: builtin.r2i imm1, imm2, v:in:top
        acc: inout:top
        format: [op_imm1_8_imm2_16_v_8]

  - title: Built-in opcode for imm8_v1_v2
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm1)
      acc = builtin(imm2, acc, v1, v2)
    semantics: |
      skip
    instructions:
      - sig: builtin.r3i imm1, imm2, v1:in:top, v2:in:top
        acc: inout:top
        format: [op_imm1_8_imm2_16_v1_8_v2_8]

  - title: Built-in opcode for imm8_v1_v2_v3
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm1)
      acc = builtin(imm2, acc, v1, v2, v3)
    semantics: |
      skip
    instructions:
      - sig: builtin.r4i imm1, imm2, v1:in:top, v2:in:top, v3:in:top
        acc: inout:top
        format: [op_imm1_8_imm2_16_v1_8_v2_8_v3_8]

  - title: Built-in opcode for id_32
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - string_id
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm)
      acc = builtin(acc, id)
    semantics: |
      skip
    instructions:
      - sig: builtin.id imm, string_id
        acc: inout:top
        format: [op_imm_8_id_32]

  - title: Built-in opcode for method_id_v_8
    description: Non-public extension of the instruction set.
    verification:
      - method_id_static
    exceptions:
      - x_none
    properties:
      - method_id
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm)
      acc = builtin(acc, method_id, v)
    semantics: |
      skip
    instructions:
      - sig: builtin.midr imm, method_id, v:in:top
        acc: inout:top
        format: [op_imm_8_id_16_v_8]

  - title: Built-in opcode for id_32_imm_16
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - string_id
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm1)
      acc = builtin(acc, id, imm2)
    semantics: |
      skip
    instructions:
      - sig: builtin.idi imm1, string_id, imm2
        acc: inout:top
        format: [op_imm1_8_id_32_imm2_16]

  - title: Built-in opcode for id_32_imm_16_v_8
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - string_id
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm1)
      acc = builtin(acc, id, imm2, v)
    semantics: |
      skip
    instructions:
      - sig: builtin.idr3i imm1, string_id, imm2, v:in:top
        acc: inout:top
        format: [op_imm1_8_id_32_imm2_16_v_8]

  - title: Built-in opcode for id_32_imm_16_v1_8_v2_8
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - string_id
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm1)
      acc = builtin(acc, id, imm2, v1, v2)
    semantics: |
      skip
    instructions:
      - sig: builtin.idr4i imm1, string_id, imm2, v1:in:top, v2:in:top
        acc: inout:top
        format: [op_imm1_8_id_32_imm2_16_v1_8_v2_8]

  - title: Built-in opcode for imm_16_imm_16_v_8
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm1)
      acc = builtin(acc, imm2, imm3, v)
    semantics: |
      skip
    instructions:
      - sig: builtin.i2r3 imm1, imm2, imm3, v:in:top
        acc: inout:top
        format: [op_imm1_8_imm2_16_imm3_16_v_8]

  - title: Built-in opcode for imm_16_imm_16
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm1)
      acc = builtin(acc, imm2, imm3)
    semantics: |
      skip
    instructions:
      - sig: builtin.i2r2 imm1, imm2, imm3
        acc: inout:top
        format: [op_imm1_8_imm2_16_imm3_16]

  - title: Built-in opcode for imm_16
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_read
      - acc_write
    pseudo: |
      builtin = resolve_builtin(imm1)
      acc = builtin(acc, imm2)
    semantics: |
      skip
    instructions:
      - sig: builtin.imm imm1, imm2
        acc: inout:top
        format: [op_imm1_8_imm2_16]

  - title: Built-in opcode with method id imm16 and two regs
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_write
      - method_id
    pseudo: |
      pseudo: |
      builtin = resolve_builtin(imm1)
      acc = builtin(id, imm2, v1, v2)
    semantics: |
      skip
    instructions:
      - sig: builtin.imr2 imm1, method_id, imm2, v1:in:top, v2:in:top
        acc: out:top
        format: [op_imm1_8_id_16_imm2_16_v1_8_v2_8]

  - title: Built-in opcode with method id and one regs
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_write
      - method_id
    pseudo: |
      pseudo: |
      builtin = resolve_builtin(imm)
      acc = builtin(id, v1)
    semantics: |
      skip
    instructions:
      - sig: builtin.idr3 imm, v1:in:top, method_id
        acc: out:top
        format: [op_imm_8_v1_8_id_16]

  - title: Built-in opcode with method id and two regs
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_write
      - method_id
    pseudo: |
      pseudo: |
      builtin = resolve_builtin(imm)
      acc = builtin(id, v1, v2)
    semantics: |
      skip
    instructions:
      - sig: builtin.idr4 imm, v1:in:top, v2:in:top, method_id
        acc: out:top
        format: [op_imm_8_v1_4_v2_4_id_16]

  - title: Built-in opcode with method id and four regs
    description: Non-public extension of the instruction set.
    verification:
      - none
    exceptions:
      - x_none
    properties:
      - acc_write
      - method_id
    pseudo: |
      pseudo: |
      builtin = resolve_builtin(imm)
      acc = builtin(id, v1, v2, v3, v4)
    semantics: |
      skip
    instructions:
      - sig: builtin.idr6 imm, v1:in:top, v2:in:top, v3:in:top, v4:in:top, method_id
        acc: out:top
        format: [op_imm_8_v1_4_v2_4_v3_4_v4_4_id_16]

builtins:

#
# f64 conversions and binary operations (including comparisons)
# that preserve f32 precision for more accurate emulation of
# Java single-precision floats. f64 is consumed and produced,
# otherwise semantics and output values match corresponding
# f64 instructions from the public part of the ISA.
#

  - sig: i32tof32
    acc: inout:i32->f64

  - sig: i64tof32
    acc: inout:i64->f64

  - sig: f64tof32
    acc: inout:f64->f64

  - sig: fadd2f32 v:in:f64
    acc: inout:f64

  - sig: fsub2f32 v:in:f64
    acc: inout:f64

  - sig: fmul2f32 v:in:f64
    acc: inout:f64

  - sig: fdiv2f32 v:in:f64
    acc: inout:f64

  - sig: fmod2f32 v:in:f64
    acc: inout:f64

  - sig: fcmpl2f32 v:in:f64
    acc: inout:f64->i32

  - sig: fcmpg2f32 v:in:f64
    acc: inout:f64->i32

#
# monitorenter and monitorexit are used to synchronize object access between threads.
# Each object is associated with a monitor, and each monitor has a counter that allows one 
# to control access to the monitor object.
#
# These two opcodes take acc as input, and acc is assumed to hold the reference to the object.
#
# * monitorenter
#    When the thread tries to gain ownership of the monitor it
#    executes monitorenter and then one of three things can happen:
#    - The monitor entry count is zero. It means the monitor does not
#      belong to any thread. Then the thread enters the monitor and sets
#      the monitor entry count to one. The thread becomes the monitor owner.
#    - The monitor already belongs to the thread. In this case the thread re-enters 
#      the monitor and increments the monitor entry count.
#    - The monitor already belongs to another thread. At this rate the thread blocks.
#      When the monitor entry count is zero, the blocked thread may try to enter
#      the monitor again.
#
#    It is worth noting that as result of this opcode, an exception may be thrown:
#    - If acc stores null then NullPointerException is thrown
#
# * monitorexit
#     When the owner thread executes monitorexit it decrements the entry monitor count.
#     If the one turns to zero, the thread exits the monitor and the monitor
#     no longer belongs to it. Then other threads may try to gain ownership
#     of the monitor. 
#
#    It is worth noting that as result of this opcode, an exception may be thrown:
#    - If acc stores null then NullPointerException is thrown
#    - If the thread that executes monitorexit is not the monitor owner then 
#      IllegalMonitorStateException is thrown
#

  - sig: monitorenter
    acc: in:ref

  - sig: monitorexit
    acc: in:ref
